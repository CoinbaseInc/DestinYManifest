<?xml version="1.0" encoding="UTF-8"?>

<!--
    Copyright (c) 2015 onox

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<system name="c172p damage">

    <channel name="gear-forces">

        <!--
            References:
                [1] https://www.youtube.com/watch?v=O1yWkbJuqkE#t=420
        -->

        <!--
            Numbers MUST be the same coefficients as spring_coeff and
            damping_coeff in the FDM for nose and main gear!
        -->

        <fcs_function name="damage/force-nose-gear">
            <function>
                <sum>
                    <product>
                        <value>1800</value><!-- spring coefficient -->
                        <property>gear/unit[0]/compression-ft</property>
                    </product>
                    <product>
                        <value>600</value><!-- damping coefficient -->
                        <property>gear/unit[0]/compression-velocity-fps</property>
                    </product>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="damage/force-left-gear">
            <function>
                <sum>
                    <product>
                        <value>5400</value><!-- spring coefficient -->
                        <property>gear/unit[1]/compression-ft</property>
                    </product>
                    <product>
                        <value>400</value><!-- damping coefficient -->
                        <property>gear/unit[1]/compression-velocity-fps</property>
                    </product>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="damage/force-right-gear">
            <function>
                <sum>
                    <product>
                        <value>5400</value><!-- spring coefficient -->
                        <property>gear/unit[2]/compression-ft</property>
                    </product>
                    <product>
                        <value>400</value><!-- damping coefficient -->
                        <property>gear/unit[2]/compression-velocity-fps</property>
                    </product>
                </sum>
            </function>
        </fcs_function>

        <switch>
            <output>gear/unit[0]/broken</output>
            <default value="gear/unit[0]/broken"/>

            <test logic="AND" value="1">
                damage/force-nose-gear GT 1500.0
                gear/unit[0]/compression-ft GT 0.3
                settings/damage eq 1
                damage/repairing EQ 0
                simulation/sim-time-sec GT 0.25
            </test>
        </switch>

        <switch>
            <output>gear/unit[1]/broken</output>
            <default value="gear/unit[1]/broken"/>

            <!-- [1] used to guess required force -->
            <test logic="AND" value="1">
                damage/force-left-gear GT 6500.0
                gear/unit[1]/compression-ft GT 0.8
                settings/damage EQ 1
                damage/repairing EQ 0
                simulation/sim-time-sec GT 0.25
            </test>

            <!-- Side force on left gear -->
            <test logic="AND" value="1">
                forces/fby-gear-lbs GT 1500.0
                gear/unit[1]/compression-ft GT 0.23
                settings/damage EQ 1
                damage/repairing EQ 0
                simulation/sim-time-sec GT 0.25
            </test>
        </switch>

        <switch>
            <output>gear/unit[2]/broken</output>
            <default value="gear/unit[2]/broken"/>

            <!-- [1] used to guess required force -->
            <test logic="AND" value="1">
                damage/force-right-gear GT 6500.0
                gear/unit[2]/compression-ft GT 0.8
                settings/damage EQ 1
                damage/repairing EQ 0
                simulation/sim-time-sec GT 0.25
            </test>

            <!-- Side force on right gear -->
            <test logic="AND" value="1">
                forces/fby-gear-lbs LT -1500.0
                gear/unit[2]/compression-ft GT 0.23
                settings/damage EQ 1
                damage/repairing EQ 0
                simulation/sim-time-sec GT 0.25
            </test>
        </switch>

    </channel>

    <channel name="wing-damage">

        <!-- Roll moment due to (diedra + roll rate + yaw rate + ailerons) -->
        <fcs_function name="damage/roll-moment">
            <function>
                <sum>
                    <property>aero/coefficient/Clb</property>
                    <property>aero/coefficient/Clp</property>
                    <property>aero/coefficient/Clr</property>
                    <property>aero/coefficient/ClDa</property>
                </sum>
            </function>
        </fcs_function>

        <!-- Limits for overspeed damage -->
        <pure_gain name="damage/limits-vne-high">
            <input>/limits/vne</input>
            <gain>1.225</gain>
        </pure_gain>
        <pure_gain name="damage/limits-vne-medium">
            <input>/limits/vne</input>
            <gain>1.14</gain>
        </pure_gain>
        <pure_gain name="damage/limits-vne-low">
            <input>/limits/vne</input>
            <gain>1.0</gain>
        </pure_gain>

        <!-- Limits for over-g damage -->
        <pure_gain name="damage/limits-lift-high">
            <input>/limits/max-lift-force</input>
            <gain>1.75</gain>
        </pure_gain>
        <pure_gain name="damage/limits-lift-medium">
            <input>/limits/max-lift-force</input>
            <gain>1.4</gain>
        </pure_gain>
        <pure_gain name="damage/limits-lift-low">
            <input>/limits/max-lift-force</input>
            <gain>1.0</gain>
        </pure_gain>

        <pure_gain name="damage/force-aero-lbs">
            <input>forces/fbz-aero-lbs</input>
            <gain>-1.0</gain>
        </pure_gain>

        <!-- Left wing damage -->
        <switch>
            <output>wing-damage/left-wing</output>
            <default value="wing-damage/left-wing"/>

            <!-- Break wing when its wing tip hits the ground or an object -->
            <test logic="AND" value="1.0">
                contact/unit[4]/compression-ft GT 0.005
            </test>

            <!-- Overspeed broken -->
            <test logic="AND" value="1.0">
                /velocities/airspeed-kt GT damage/limits-vne-high
                crash EQ 0
                wing-damage/left-wing LT 1.0
            </test>

            <!-- Overspeed broken -->
            <test logic="AND" value="1.0">
                /velocities/airspeed-kt GT damage/limits-vne-medium
                damage/roll-moment GT 4000.0
                wing-damage/right-wing LT 0.5<!-- Change to wing-damage/left-wing LT 0.5? -->
            </test>

            <!-- Over-g broken -->
            <test logic="AND" value="1.0">
                damage/force-aero-lbs GT damage/limits-lift-high
                crash EQ 0
            </test>

            <!-- Over-g broken -->
            <test logic="AND" value="1.0">
                damage/force-aero-lbs GT damage/limits-lift-medium
                damage/roll-moment GT 4000.0
                wing-damage/right-wing LT 1.0<!-- Change to wing-damage/left-wing LT 1.0? -->
            </test>

            <!-- Over-g damage -->
            <test logic="AND" value="0.3">
                damage/force-aero-lbs GT damage/limits-lift-medium
                damage/roll-moment LT 4000.0
                damage/roll-moment GT -4000.0
                wing-damage/right-wing LT 0.3<!-- Change to wing-damage/left-wing LT 0.3? -->
            </test>

            <!-- Overspeed damage -->
            <test logic="AND" value="0.3">
                /velocities/airspeed-kt GT damage/limits-vne-medium
                damage/roll-moment LT 4000.0
                damage/roll-moment GT -4000.0
                wing-damage/left-wing EQ 0.0<!-- Change to wing-damage/left-wing LT 0.3? -->
            </test>

            <!-- Overspeed damage -->
            <test logic="AND" value="0.12">
                /velocities/airspeed-kt GT damage/limits-vne-low
                damage/roll-moment GT 4000.0
                wing-damage/right-wing EQ 0.0<!-- Change to wing-damage/left-wing LT 0.12? -->
            </test>

            <!-- Over-g damage -->
            <test logic="AND" value="0.12">
                damage/force-aero-lbs GT damage/limits-lift-medium
                damage/roll-moment LT 4000.0
                damage/roll-moment GT -4000.0
                wing-damage/right-wing EQ 0.0<!-- Change to wing-damage/left-wing EQ 0.0? -->
            </test>

            <!-- Over-g damage -->
            <test logic="AND" value="0.12">
                damage/force-aero-lbs GT damage/limits-lift-low
                damage/roll-moment GT 4000.0
                wing-damage/right-wing EQ 0.0<!-- Change to wing-damage/left-wing EQ 0.0? -->
            </test>
        </switch>

        <!-- Right wing damage -->
        <switch>
            <output>wing-damage/right-wing</output>
            <default value="wing-damage/right-wing"/>

            <!-- Break wing when its wing tip hits the ground or an object -->
            <test logic="AND" value="1.0">
                contact/unit[5]/compression-ft GT 0.005
            </test>

            <!-- Overspeed broken -->
            <test logic="AND" value="1.0">
                /velocities/airspeed-kt GT damage/limits-vne-high
                crash EQ 0
                wing-damage/right-wing LT 1.0
            </test>

            <!-- Overspeed broken -->
            <test logic="AND" value="1.0">
                /velocities/airspeed-kt GT damage/limits-vne-medium
                damage/roll-moment LT -4000.0
                wing-damage/left-wing LT 0.5<!-- Change to wing-damage/right-wing LT 0.5? -->
            </test>

            <!-- Over-g broken -->
            <test logic="AND" value="1.0">
                damage/force-aero-lbs GT damage/limits-lift-high
                crash EQ 0
            </test>

            <!-- Over-g broken -->
            <test logic="AND" value="1.0">
                damage/force-aero-lbs GT damage/limits-lift-medium
                damage/roll-moment LT -4000.0
                wing-damage/left-wing LT 1.0<!-- Change to wing-damage/right-wing LT 1.0? -->
            </test>

            <!-- Over-g damage -->
            <test logic="AND" value="0.3">
                damage/force-aero-lbs GT damage/limits-lift-medium
                damage/roll-moment LT 4000.0
                damage/roll-moment GT -4000.0
                wing-damage/left-wing LT 0.3<!-- Change to wing-damage/right-wing LT 0.3? -->
            </test>

            <!-- Overspeed damage -->
            <test logic="AND" value="0.3">
                /velocities/airspeed-kt GT damage/limits-vne-medium
                damage/roll-moment LT 4000.0
                damage/roll-moment GT -4000.0
                wing-damage/right-wing EQ 0.0<!-- Change to wing-damage/right-wing LT 0.3? -->
            </test>

            <!-- Overspeed damage -->
            <test logic="AND" value="0.12">
                /velocities/airspeed-kt GT damage/limits-vne-low
                damage/roll-moment LT -4000.0
                wing-damage/left-wing EQ 0.0<!-- Change to wing-damage/right-wing LT 0.12? -->
            </test>

            <!-- Over-g damage -->
            <test logic="AND" value="0.12">
                damage/force-aero-lbs GT damage/limits-lift-medium
                damage/roll-moment LT 4000.0
                damage/roll-moment GT -4000.0
                wing-damage/left-wing EQ 0.0<!-- Change to wing-damage/right-wing EQ 0.0? -->
            </test>

            <!-- Over-g damage -->
            <test logic="AND" value="0.12">
                damage/force-aero-lbs GT damage/limits-lift-low
                damage/roll-moment LT -4000.0
                wing-damage/left-wing EQ 0.0<!-- Change to wing-damage/right-wing EQ 0.0? -->
            </test>
        </switch>

    </channel>

</system>
